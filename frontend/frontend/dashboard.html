<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard de Desempenho</title>
  <!-- Favicon para evitar 404 -->
  <link rel="icon" href="favicon.png" type="image/png" />
  <!-- ðŸ”¹ CSS principal -->
  <link rel="stylesheet" href="styles/style.css" />

  <!-- 1. Importar Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- 2. Importar pomodoro.js -->
  <script defer src="pomodoro.js"></script>
  <!-- 3. Importar script de Estudo DiÃ¡rio -->
  <script defer src="scripts/script_estudo_diario.js"></script>

  <!-- ðŸ”¹ Estilo rÃ¡pido do Pomodoro e conquistas -->
  <style>
    /* â€¦ seu CSS inalterado â€¦ */
  </style>
</head>

<body>

  <!-- â€¦ seu HTML inalterado â€¦ -->

  <!-- Script para buscar dados e desenhar o grÃ¡fico, conquistas e check-in diÃ¡rio -->
  <script>
    const API_URL = 'http://127.0.0.1:8000';
    const alunoId = 1;

    document.addEventListener('DOMContentLoaded', () => {
      loadAluno(alunoId);
      loadResumo(alunoId);
      desenharGrafico(alunoId);
      carregarConquistas(alunoId);
      atualizarStreak();

      // Event listener de check-in sÃ³ apÃ³s DOM pronto
      document.getElementById('btn-checkin').addEventListener('click', async () => {
        try {
          await fetch(`${API_URL}/modo_estudo/${alunoId}/checkin`, { method: 'POST' });
          await atualizarStreak();
        } catch (err) {
          console.error('Erro no check-in de estudo:', err);
        }
      });
    });

    async function loadAluno(id) {
      try {
        const res = await fetch(`${API_URL}/aluno/${id}`);
        if (!res.ok) throw new Error(`Status ${res.status}`);
        const { nome } = await res.json();
        document.getElementById('aluno-nome').textContent = nome;
      } catch (err) {
        console.error('Erro ao carregar aluno:', err);
      }
    }

    async function loadResumo(id) {
      try {
        let res = await fetch(`${API_URL}/progresso/${id}`);
        if (!res.ok) throw new Error(`Status ${res.status}`);
        const progresso = await res.json();
        const notas = Object.values(progresso);
        const media = notas.length
          ? (notas.reduce((a, b) => a + b, 0) / notas.length).toFixed(1)
          : '--';
        document.getElementById('media-nota').textContent = media;

        // rota corrigida para /prova
        res = await fetch(`${API_URL}/prova/${id}`);
        if (!res.ok) throw new Error(`Status ${res.status}`);
        const provas = await res.json();
        document.getElementById('provas-concluidas').textContent = provas.length;

        document.getElementById('metas-diarias').textContent = 'Estudar 1h hoje';
      } catch (err) {
        console.error('Erro ao carregar resumo:', err);
      }
    }

    async function desenharGrafico(alunoId) {
      try {
        const resp = await fetch(`${API_URL}/graficos/desempenho/${alunoId}`);
        if (!resp.ok) throw new Error(`Status ${resp.status}`);
        const json = await resp.json();
        const dataObj = json.desempenho;
        const materias = Object.keys(dataObj);
        const todasDatas = Array.from(new Set(
          materias.flatMap(mat => dataObj[mat].map(e => e.data))
        )).sort();
        const datasets = materias.map((mat, idx) => {
          const dataPontos = todasDatas.map(d =>
            (dataObj[mat].find(e => e.data === d) || {}).acertos || 0
          );
          const hue = (idx * 60) % 360;
          return {
            label: mat,
            data: dataPontos,
            borderColor: `hsl(${hue}, 70%, 50%)`,
            // Remove a '}' extra que quebrava o parse
            backgroundColor: `hsl(${hue}, 70%, 80%)`,
            fill: false,
            tension: 0.1
          };
        });
        const ctx = document.getElementById('graficoDesempenho').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: { labels: todasDatas, datasets },
          options: {
            responsive: true,
            plugins: {
              title: { display: true, text: 'Desempenho de Acertos por MatÃ©ria' },
              legend: { position: 'top' }
            },
            scales: {
              x: { title: { display: true, text: 'Data' } },
              y: { title: { display: true, text: 'NÃºmero de Acertos' }, beginAtZero: true }
            }
          }
        });
      } catch (err) {
        console.error('Erro ao carregar dados do grÃ¡fico:', err);
      }
    }

    async function carregarConquistas(alunoId) {
      try {
        const resp = await fetch(`${API_URL}/conquistas/${alunoId}`);
        if (!resp.ok) throw new Error(`Status ${resp.status}`);
        const conquistas = await resp.json();
        const ul = document.getElementById('listaConquistas');
        ul.innerHTML = '';
        conquistas.forEach(c => {
          const li = document.createElement('li');
          li.textContent = `${new Date(c.data_conquista).toLocaleDateString()} â€“ ${c.titulo}`;
          ul.appendChild(li);
        });
      } catch (err) {
        console.error('Erro ao carregar conquistas:', err);
      }
    }

    async function atualizarStreak() {
      try {
        const res = await fetch(`${API_URL}/modo_estudo/${alunoId}/streak`);
        if (!res.ok) throw new Error(`Status ${res.status}`);
        const { streak } = await res.json();
        document.getElementById('seu-streak').textContent = streak;
      } catch (err) {
        console.error('Erro ao obter streak:', err);
      }
    }
  </script>

</body>
</html>




































